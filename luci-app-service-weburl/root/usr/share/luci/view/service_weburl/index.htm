<%+header%>
<h2><%:服务列表%></h2>

<div class="cbi-page-actions">
    <a href="<%=url('admin/services/settings')%>" class="btn cbi-button-add"><%:添加服务%></a>
</div>

<div class="cbi-section">
    <div class="cbi-section-descr"><%:当前所有可用的服务链接%></div>
    
    <!-- 搜索框 -->
    <div class="cbi-value">
        <label class="cbi-value-title"><%:搜索服务%></label>
        <div class="cbi-value-field">
            <input type="text" id="search" placeholder="<%:输入关键词搜索%>" class="cbi-input-text" />
        </div>
    </div>
    
    <!-- 服务列表 -->
    <div class="table cbi-section-table" id="services-list">
        <% if #services == 0 then %>
        <div class="tr cbi-section-table-row">
            <div class="td"><em><%:暂无服务数据%></em></div>
        </div>
        <% else %>
            <% for i, service in ipairs(services) do %>
            <div class="tr cbi-section-table-row service-item" 
                 data-title="<%=pcdata(service.title)%>" 
                 data-desc="<%=pcdata(service.description or '')%>">
                <div class="td">
                    <h3><%=pcdata(service.title)%></h3>
                    <% if service.description and #service.description > 0 then %>
                    <p><%=pcdata(service.description)%></p>
                    <% end %>
                    <div class="service-meta">
                        <span><%:创建时间%>: <%=os.date("%Y-%m-%d %H:%M", service.created_at)%></span>
                        <% if service.updated_at and service.updated_at ~= service.created_at then %>
                        <span><%:更新时间%>: <%=os.date("%Y-%m-%d %H:%M", service.updated_at)%></span>
                        <% end %>
                    </div>
                    <a href="<%=pcdata(service.url)%>" target="_blank" class="btn"><%:访问服务%></a>
                </div>
                <div class="td cbi-section-actions">
                    <a href="<%=url('admin/services/settings?id='..service.id)%>" class="btn cbi-button-edit"><%:编辑%></a>
                    <button onclick="confirmDelete('<%=service.id%>', '<%=pcdata(service.title)%>')" 
                            class="btn cbi-button-remove"><%:删除%></button>
                </div>
            </div>
            <% end %>
        <% end %>
    </div>
</div>

<script type="text/javascript">
// 搜索功能
document.getElementById('search').addEventListener('input', function(e) {
    var searchText = e.target.value.toLowerCase();
    var items = document.querySelectorAll('.service-item');
    
    items.forEach(function(item) {
        var title = item.getAttribute('data-title').toLowerCase();
        var desc = item.getAttribute('data-desc').toLowerCase();
        
        if (title.includes(searchText) || desc.includes(searchText)) {
            item.style.display = '';
        } else {
            item.style.display = 'none';
        }
    });
});

// 删除确认
function confirmDelete(id, title) {
    if (confirm('确定要删除服务 "' + title + '" 吗？')) {
        fetch('<%=url("admin/services/delete_service")%>', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'id=' + encodeURIComponent(id)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.reload();
            } else {
                alert('删除失败: ' + (data.message || '未知错误'));
            }
        })
        .catch(error => {
            alert('请求失败: ' + error);
        });
    }
}
</script>

<%+footer%>