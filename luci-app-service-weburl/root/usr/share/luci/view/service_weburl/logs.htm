<%+header%>
<h2><%:操作日志%></h2>

<div class="cbi-section">
    <div class="cbi-section-descr"><%:系统操作记录，最近30天的日志将被保留%></div>
    
    <!-- 时间筛选 -->
    <div class="cbi-value">
        <label class="cbi-value-title"><%:时间范围%></label>
        <div class="cbi-value-field">
            <input type="date" id="start-date" class="cbi-input-text" />
            <span> 至 </span>
            <input type="date" id="end-date" class="cbi-input-text" />
            <button class="btn cbi-button" onclick="filterLogs()"><%:筛选%></button>
            <button class="btn cbi-button" onclick="resetFilter()"><%:重置%></button>
        </div>
    </div>
    
    <!-- 日志表格 -->
    <div class="table cbi-section-table">
        <div class="tr table-titles">
            <div class="th"><%:时间%></div>
            <div class="th"><%:操作类型%></div>
            <div class="th"><%:关联服务%></div>
            <div class="th"><%:操作%></div>
        </div>
        
        <% if #logs == 0 then %>
        <div class="tr">
            <div class="td" colspan="4"><em><%:暂无日志数据%></em></div>
        </div>
        <% else %>
            <% for i, log in ipairs(logs) do %>
            <div class="tr">
                <div class="td"><%=os.date("%Y-%m-%d %H:%M:%S", log.timestamp)%></div>
                <div class="td"><%=pcdata(log.action)%></div>
                <div class="td">
                    <% if log.service_id then %>
                    <a href="<%=url('admin/services/settings?id='..log.service_id)%>">
                        <%:服务ID%> <%=log.service_id%>
                    </a>
                    <% else %>
                    <em><%:无关联服务%></em>
                    <% end %>
                </div>
                <div class="td">
                    <button class="btn cbi-button" onclick="showLogDetails('<%=pcdata(json.stringify(log))%>')">
                        <%:详情%>
                    </button>
                </div>
            </div>
            <% end %>
        <% end %>
    </div>
    
    <!-- 分页控件 -->
    <% if total > page_size then %>
    <div class="cbi-page-actions">
        <% if page > 1 then %>
        <a href="<%=url('admin/services/logs?page='..(page-1))%>" class="btn cbi-button"><%:上一页%></a>
        <% end %>
        
        <span><%:第%> <%=page%> <%:页，共%> <%=math.ceil(total/page_size)%> <%:页%></span>
        
        <% if page * page_size < total then %>
        <a href="<%=url('admin/services/logs?page='..(page+1))%>" class="btn cbi-button"><%:下一页%></a>
        <% end %>
    </div>
    <% end %>
</div>

<!-- 日志详情弹窗 -->
<div id="log-details-modal" class="cbi-modal" style="display:none">
    <div class="cbi-modal-content">
        <div class="cbi-modal-header">
            <h3><%:日志详情%></h3>
            <button class="btn cbi-button-close" onclick="hideLogDetails()">&times;</button>
        </div>div>
        <div class="cbi-modal-body" id="log-details-content">
            <!-- 日志详情内容将在这里动态加载 -->
        </div>
        <div class="cbi-modal-footer">
            <button class="btn cbi-button" onclick="hideLogDetails()"><%:关闭%></button>
        </div>
    </div>
</div>

<script type="text/javascript">
// 显示日志详情
function showLogDetails(logJson) {
    try {
        var log = JSON.parse(logJson);
        var content = '<div class="log-details">';
        
        content += '<p><strong><%:操作时间%>:</strong> ' + new Date(log.timestamp * 1000).toLocaleString() + '</p>';
        content += '<p><strong><%:操作类型%>:</strong> ' + log.action + '</p>';
        
        if (log.service_id) {
            content += '<p><strong><%:关联服务ID%>:</strong> ' + 
                      '<a href="<%=url("admin/services/settings?id=")%>' + log.service_id + '">' + 
                      log.service_id + '</a></p>';
        }
        
        if (log.message && typeof log.message === 'object') {
            content += '<p><strong><%:操作详情%>:</strong></p>';
            content += '<pre>' + JSON.stringify(log.message, null, 2) + '</pre>';
        } else if (log.message) {
            content += '<p><strong><%:操作数据%>:</strong> ' + log.message + '</p>';
        }
        
        content += '</div>';
        
        document.getElementById('log-details-content').innerHTML = content;
        document.getElementById('log-details-modal').style.display = 'block';
    } catch (e) {
        alert('<%:解析日志失败%>: ' + e.message);
    }
}

// 隐藏日志详情
function hideLogDetails() {
    document.getElementById('log-details-modal').style.display = 'none';
}

// 筛选日志
function filterLogs() {
    var startDate = document.getElementById('start-date').value;
    var endDate = document.getElementById('end-date').value;
    
    if (startDate || endDate) {
        var url = '<%=url("admin/services/logs")%>';
        if (startDate) url += '&start=' + encodeURIComponent(startDate);
        if (endDate) url += '&end=' + encodeURIComponent(endDate);
        window.location.href = url;
    } else {
        alert('<%:请至少选择一个时间筛选条件%>');
    }
}

// 重置筛选
function resetFilter() {
    document.getElementById('start-date').value = '';
    document.getElementById('end-date').value = '';
    window.location.href = '<%=url("admin/services/logs")%>';
}

// 初始化日期选择器
document.addEventListener('DOMContentLoaded', function() {
    var today = new Date();
    document.getElementById('end-date').valueAsDate = today;
    
    var oneWeekAgo = new Date();
    oneWeekAgo.setDate(today.getDate() - 7);
    document.getElementById('start-date').valueAsDate = oneWeekAgo;
});
</script>

<%+footer%>