<%+header%>

<script type="text/javascript">//<![CDATA[
    var editId = null;

    window.addEventListener('load', function() {
        // 检查是否是编辑模式
        var urlParams = new URLSearchParams(window.location.search);
        editId = urlParams.get('id');
        
        if (editId) {
            loadServiceData(editId);
            document.getElementById('page-title').innerText = '<%:Edit Service%>';
        }
    });

    function loadServiceData(id) {
        XHR.get('<%=luci.dispatcher.build_url("admin", "services", "service_weburl", "get_services")%>', null,
            function(x, data) {
                if (data) {
                    var service = data.find(function(s) { return s.id == id; });
                    if (service) {
                        document.getElementById('title').value = service.title;
                        document.getElementById('url').value = service.url;
                        document.getElementById('description').value = service.description || '';
                    }
                }
            }
        );
    }

    function validateForm() {
        var title = document.getElementById('title').value.trim();
        var url = document.getElementById('url').value.trim();
        
        if (!title) {
            alert('<%:Please enter a title%>');
            return false;
        }
        
        if (!url) {
            alert('<%:Please enter a URL%>');
            return false;
        }
        
        // 简单的URL格式验证
        if (!url.match(/^https?:\/\/.+/)) {
            alert('<%:Please enter a valid URL starting with http:// or https://%>');
            return false;
        }
        
        return true;
    }

    function submitForm() {
        if (!validateForm()) {
            return;
        }

        var data = {
            title: document.getElementById('title').value.trim(),
            url: document.getElementById('url').value.trim(),
            description: document.getElementById('description').value.trim()
        };

        if (editId) {
            data.id = editId;
        }

        var endpoint = editId ? 
            '<%=luci.dispatcher.build_url("admin", "services", "service_weburl", "edit_service")%>' :
            '<%=luci.dispatcher.build_url("admin", "services", "service_weburl", "add_service")%>';

        XHR.post(endpoint, data,
            function(x, result) {
                if (result && result.success) {
                    window.location.href = '<%=luci.dispatcher.build_url("admin", "services", "service_weburl", "index")%>';
                } else {
                    alert(result && result.message || '<%:Operation failed%>');
                }
            }
        );
    }
//]]></script>

<style>
.form-field {
    margin-bottom: 1em;
}

.form-field label {
    display: block;
    margin-bottom: 0.5em;
    font-weight: bold;
}

.form-field input[type="text"],
.form-field textarea {
    width: 100%;
    max-width: 600px;
    padding: 0.5em;
    border: 1px solid #ccc;
    border-radius: 4px;
}

.form-field textarea {
    height: 100px;
}

.form-buttons {
    margin-top: 1em;
}

.required {
    color: red;
    margin-left: 0.2em;
}
</style>

<h2 id="page-title"><%:Add New Service%></h2>

<div class="cbi-map">
    <div class="cbi-section">
        <div class="form-field">
            <label for="title"><%:Title%><span class="required">*</span></label>
            <input type="text" id="title" name="title" required>
        </div>
        
        <div class="form-field">
            <label for="url"><%:URL%><span class="required">*</span></label>
            <input type="text" id="url" name="url" placeholder="https://" required>
        </div>
        
        <div class="form-field">
            <label for="description"><%:Description%></label>
            <textarea id="description" name="description"></textarea>
        </div>
        
        <div class="form-buttons">
            <button onclick="submitForm()" class="btn cbi-button cbi-button-save"><%:Save%></button>
            <button onclick="window.location.href='<%=luci.dispatcher.build_url("admin", "services", "service_weburl", "index")%>'" class="btn cbi-button cbi-button-reset"><%:Cancel%></button>
        </div>
    </div>
</div>

<%+footer%>